# =============================================================================
# Cloud-Native-Ops-Starter - Nginx Ingress Controller Helm Values
# =============================================================================
# Production configuration for Nginx Ingress Controller deployment via Helm.
# Deploy with: helm install ingress-nginx ingress-nginx/ingress-nginx -f values.yaml
# =============================================================================

controller:
  # ---------------------------------------------------------------------------
  # Replica Configuration
  # ---------------------------------------------------------------------------
  replicaCount: 2
  
  # ---------------------------------------------------------------------------
  # Resource Management
  # ---------------------------------------------------------------------------
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  
  # ---------------------------------------------------------------------------
  # Service Configuration (AWS NLB)
  # ---------------------------------------------------------------------------
  service:
    enabled: true
    type: LoadBalancer
    
    annotations:
      # Use AWS Network Load Balancer
      service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
      service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
      service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
      
      # Health check configuration
      service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: "HTTP"
      service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: "/healthz"
      service.beta.kubernetes.io/aws-load-balancer-healthcheck-interval: "10"
      
      # SSL termination at Cloudflare, so NLB handles TCP
      service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "tcp"
    
    externalTrafficPolicy: Local
  
  # ---------------------------------------------------------------------------
  # Pod Configuration
  # ---------------------------------------------------------------------------
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 101
    runAsGroup: 101
  
  # ---------------------------------------------------------------------------
  # Metrics for Prometheus
  # ---------------------------------------------------------------------------
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: monitoring
  
  # ---------------------------------------------------------------------------
  # Affinity Rules
  # ---------------------------------------------------------------------------
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - ingress-nginx
            topologyKey: kubernetes.io/hostname
  
  # ---------------------------------------------------------------------------
  # Tolerations for Spot Instances
  # ---------------------------------------------------------------------------
  tolerations:
    - key: "kubernetes.io/arch"
      operator: "Equal"
      value: "amd64"
      effect: "NoSchedule"

  # ---------------------------------------------------------------------------
  # Config Map Settings
  # ---------------------------------------------------------------------------
  config:
    # Cloudflare IP preservation
    use-forwarded-headers: "true"
    compute-full-forwarded-for: "true"
    
    # Security settings
    hide-headers: "Server,X-Powered-By"
    ssl-redirect: "true"
    
    # Performance
    keep-alive: "75"
    keep-alive-requests: "1000"
    
    # Logging
    log-format-upstream: '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" $request_length $request_time [$proxy_upstream_name] [$proxy_alternative_upstream_name] $upstream_addr $upstream_response_length $upstream_response_time $upstream_status $req_id'

# -----------------------------------------------------------------------------
# Default Backend
# -----------------------------------------------------------------------------
defaultBackend:
  enabled: true
  resources:
    requests:
      cpu: 10m
      memory: 20Mi
    limits:
      cpu: 50m
      memory: 50Mi
